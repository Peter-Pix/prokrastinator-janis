<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Janis: Mistr Prokrastinace</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Roboto+Mono:wght@400;700&display=swap');
	
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafafa; /* Instagram-like light background */
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container-shadow {
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #dbdbdb;
        }
        .typewriter-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            margin-left: 2px;
            background-color: #262626;
            animation: blink 0.7s infinite;
        }
.text-sm {font-size: 12px!important}
@keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .chat-message {
    max-width: 80%;
    padding: 8px 12px;
    border-radius: 22px;
    margin: 8px;
    font-weight: 400;
    font-size: 12px;
    line-height: 1.4;
        text-align: left;
    padding-left: 18px;
}
        /* Janis Bubble: Instagram-like message bubble */
        .janis-bubble {
            background-color: #efefef;
            color: #262626;
            align-self: flex-start;
            border: none;
            border-bottom-left-radius: 4px;
        }
        /* Player Bubble: Instagram DM style */
        .player-bubble {
            background-color: #0095f6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .chat-history {
            height: calc(100vh - 200px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 16px;
            background-color: #fafafa;
            /* Instagram-like scrollbar */
            scrollbar-width: none;
        }
        .chat-history::-webkit-scrollbar {
            display: none;
        }
        /* Instagram header style */
        .instagram-header {
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            background: white;
            border-bottom: 1px solid #dbdbdb;
        }
        /* Typing indicator */
        .typing-indicator {
            background-color: #efefef;
            padding: 12px 16px;
            border-radius: 22px;
            align-self: flex-start;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border-bottom-left-radius: 4px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #8e8e8e;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        /* CSS pro animaci modalu */
        .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal-show .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-hide .modal-content {
            transform: scale(0.95);
            opacity: 0;
        }
        /* Instagram-style message buttons */
        .chat-option-btn {
            @apply px-4 py-3 bg-blue-500 text-white font-normal rounded-lg hover:bg-blue-600 transition duration-150 border border-blue-600 text-sm text-left w-full;
        }
.chat-option-btn:disabled {
             @apply bg-gray-100 text-gray-400 cursor-not-allowed border-gray-200;
        }
        /* Instagram bottom input bar */
        .message-input-container {
            background: white;
            border-top: 1px solid #dbdbdb;
            padding: 12px 16px;
        }

</style>
</head>
<body class="bg-white">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center text-gray-800">
        <div class="w-16 h-16 border-4 border-gray-300 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <div class="text-lg font-medium">Janis se p콏ipojuje...</div>
        <p class="mt-2 text-sm text-gray-500">Na캜칤t치m konverzaci</p>
    </div>
    <!-- Main Container -->
    <div class="w-full max-w-md mx-auto h-screen bg-white flex flex-col">
        <!-- Instagram-like Header -->
        <div class="instagram-header px-4 py-3 flex items-center justify-between border-b border-gray-300">
            <div class="flex items-center space-x-3">
                <!-- Back button -->
                <button class="text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <!-- Profile picture and name -->
                <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-pink-500 rounded-full"></div>
                <div>
                    <h2 class="font-semibold text-sm">janis_procrastination</h2>
                    <p class="text-xs text-gray-500">Online p콏ed chv칤l칤</p>
                </div>
            </div>
            <!-- Settings and more options -->
            <div class="flex items-center space-x-3">
                <button class="text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                    </svg>
                </button>
                <button id="settings-button" class="text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Interface -->
        <div id="game-container" class="flex-1 flex flex-col transition-opacity duration-500 opacity-0 hidden">
            
            <!-- Chat History Display -->
            <div id="chat-history" class="chat-history flex-grow">
                <div class="janis-bubble chat-message">
                    Ahoj, jsem Janis游녦
                </div>

            </div>
        <!-- Current Response Area -->
        <div class="message-input-container">
            <!-- Typing indicator will be shown in chat history instead -->

            <!-- Dynamic Options Container -->
            <div id="player-options-container" class="space-y-3 mt-4">
                <!-- Dynamic buttons will be added here by JS -->
            </div>

            <!-- Stats bar (minimal, Instagram-style) -->
            <div class="mt-4 pt-3 border-t border-gray-200">
                <div class="flex justify-between items-center text-xs text-gray-500">
                    <span>Interakce: <span id="interaction-count" class="font-medium">0</span></span>
                    <span id="user-id-display" class="text-gray-400">Na캜칤t치m...</span>
                </div>
            </div>
        </div>
</div>
    </div>

    <!-- Notification/Message Box -->
    <div id="message-box" class="fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-black bg-opacity-80 text-white text-sm rounded-lg shadow-xl hidden transition-opacity duration-300 z-50">
        <!-- Messages appear here -->
    </div>
<!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center transition-opacity duration-300 opacity-0 modal-hide">
        <div class="modal-content bg-white text-gray-900 rounded-xl p-6 w-11/12 max-w-md shadow-2xl transform scale-95">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-semibold text-slate-800">Nastaven칤 Hry</h3>
                <button id="close-settings" class="text-gray-500 hover:text-gray-800">
                    <!-- Close Icon (X) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            <div class="space-y-4">
                <p class="text-sm text-gray-600 font-normal">
                    Pokud nen칤 k dispozici Firebase, hra se automaticky spust칤 v m칤stn칤m re쬴mu. Zde m콢쬰te nastavit, zda se maj칤 data (po캜et interakc칤) ukl치dat lok치ln캩 do prohl칤쬰캜e.
                </p>

                <div class="flex items-center justify-between p-3 bg-slate-100 rounded-lg border border-slate-200">
                    <label for="local-storage-toggle" class="text-slate-800 font-medium select-none cursor-pointer">
                        Ukl치dat stav lok치ln캩 (do prohl칤쬰캜e)
                    </label>
                    <input type="checkbox" id="local-storage-toggle" class="form-checkbox h-5 w-5 text-red-600 bg-gray-200 border-gray-300 rounded focus:ring-red-500 transition duration-150 ease-in-out cursor-pointer">
                </div>
                
                <p id="storage-status" class="text-xs text-red-600 italic font-normal"></p>
            </div>
        </div>
    </div>



    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP ---
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // Pou쬴t칤 window.__initial_auth_token pro zamezen칤 Temporal Dead Zone
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : undefined;
        
        // Kl칤캜 pro Local Storage
        const LOCAL_STORAGE_KEY = `janis_pity_game_state_local_${appId}`;
        const SETTINGS_KEY = `janis_pity_game_settings_${appId}`;


        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isFirebaseDisabled = false; // Flag pro z치lo쬹칤 re쬴m
        
        let gameState = {
            interactionsCount: 0, 
        };

        let userSettings = {
            useLocalStorage: false // Default vypnuto
        };

        let isTyping = false;
        
        // --- HISTORY TRACKING FOR NON-REPETITION (new feature) ---
        const HISTORY_LIMIT = 5; // Minim치ln칤 po캜et tah콢 p콏ed opakov치n칤m
        let playerTemplateHistory = []; // Historie index콢 pro dvojice hr치캜ov칳ch zpr치v
        let openingHistory = []; // Historie index콢 pro Janisovy 칰vodn칤 fr치ze
        let excuseHistory = []; // Historie index콢 pro Janisovy hlavn칤 v칳mluvy
        let endingHistory = []; // Historie index콢 pro Janisovy z치v캩re캜n칠 fr치ze
        // ---------------------------------------------------------


        // --- GAME CONTENT (Combinatorial Excuses and Player Templates) ---

        // 1. OPENINGS (A 10 r콢zn칳ch obrat콢)
        const OPENINGS = [
            "Promi켿, v캜era jsem, b캩hal po 칰콏adech. ",
            "V칤m, 쬰 jsem to sl칤bil, ud캩l치m to. ",
	        "Nev캩콏il bys, co se stalo. ",
	        "Stra코n캩 pomalu se u캜칤m, nikdy mi to ne코lo. ",
            "Od mala jsem m캩l probl칠my s dochvilnost칤. ",
            "U jako d칤t캩 jsem byl takov칳. ",
            "M치ma m캩 do toho nutila, m치m k tomu te캞 odpor...",
            "U mockr치t jsem to zkou코el... ",
            "Marketing ned캩l치m, n캩koho na to najdem! ",
            "Sorry, nefeeluju to, nejsem to j치. ",
            "Promi켿, nem캩l jsem na to s칤lu, padla na m캩 deprese. ",
            "Bylo to skoro hotov칠... ",
            "Hele, fakt se sna쮂셠, ale zrovna dneska je to na hlavu! ",
            "M캩l jsem velkou v캩c. ",
            "Te캞 to nejde, jinak bych to ud캩lal. ",
            "Rozjel jsem to! Pak jsem zjistil, 쬰 ne... ",
            "Zdr쬰la m캩 ne캜ekan치 ud치lost. ",
            "Musel jsem za콏칤dit n캩co jin칳ho. ",
            "Mus칤코 pochopit, 쬰 to nen칤 jen tak ",
            "Narazil jsem na probl칠m. "
        ];

        // 2. MIDDLE / MASO (P콢vodn칤 v칳mluvy)
        const EXCUSES = [
            "U jsem na to asi fakt star칳 ",
            "Nen칤 to moje vina. ",
            "Mus칤m si to srovnat v hlav캩... ",
            "Nejd콏칤v p콏칤코t칤 t칳den, d콏칤v to nep콢jde. ",
            "Dnes m치m napl치novan칳 uklidit, v tom chaosu nem콢쬿 procovat. ",
            "Odpoledne, j치 dopoledne nejsem tak produktivn칤 ",
            "Nekus칤me n캩co slo쬴t캩j코칤ho, vid캩l jsem na Instagramu jak na tom vyd캩l치vaj칤 velkej bal칤k ",
            "Nev칤m, nedok치쬿 se na to vyladit! ",
            "Pracoval jsem na tom, ale pak jsem usnul v k콏esle. ",
            "K치mo코 m캩l narozeniny, musel jsem se tam aspo켿 na chv칤li pod칤vat ",
            "Jdu ven s t칳pkem, vlastn칤 5 firem, ten kontakt se bude hodit! ",
            "To trv치 moc dlouho. Napadne m캩 ur캜it캩 n캩co lep코칤ho ",
            "Bylo mi fakt n캩jak 코patn캩 ",
            "M치m nep콏ekonatelnou 칰zkost, jsem r치d 쬰 jsem vstal z postele ",
            "Jsem z tebe nerv칩zn칤, mus칤m se j칤t n캩kam uklidnit ",
            "Nec칤t칤m se dob콏e, kdy m캩 po콏치d kontroluje코! ",
            "Ty m캩 demotivuje코! ",
            "Jsem na manu치ln칤 pr치ci... R치d d캩l치m n캩co, co je hned vid캩t  ",
            "To je pravda. 콎칤kala to i m치ma ",
            "Nezn치m nikoho, kdo by mi pomohl ",
            "Koupil jsem si vitam칤ny",
            "Mus칤m si odpo캜inout ",
            "P콢jdu se vyspat, a콘 na to m치m energii ",
            "Te캞 p콏ed sv치tkama, to v콢bec ne ",
            "Mn캩 p콏ijde, 쬰 to zbyte캜n캩 hrot칤코 ",
            "Kam tak sp캩ch치코? ",
            "D콏칤v jsem hodn캩 zkoumal v캩ci ",
            "M치m 칰zkost, kdy jsi negativn칤 ",
            "U n캩co m치m, u jsem to sl칤bil ", 
            "U to m치m v pl치nu na z칤tra. ",
            "Nikdo m캩 to nikdy neu캜il. ",
            "J치 nev칤m, co a jak se d캩l치... ",
            "Chci n캩co origin치ln칤ho ",
            "M캩l jsem slab칳 internetov칳 p콏ipojen칤 ",
            "Nebudu si na to d캩lat tabulky, nejsem blbec! ",
            "Kdy tla캜칤코, m캩 to demotivuje! ",
            "Fakt se sna쮂셠 ",
        ];

        // 3. ENDINGS (Koncov칠 fr치ze)
        const ENDINGS = [
            "Rozhodil jsi m캩 tou ot치zkou",
            "Hmm, divn칳..",
            "Tak snad p콏칤코t캩",
            "Pro캜 bych lhal?",
            "M치m posledn칤 dobou probl칠m se soust콏edit",
            "Dost hektick칳 obdob칤",
            "P콏칤코t칤 t칳den",
	        "Myslel jsem, 쬰 si d캩l치코 srandu",
        ];
        
        // PLAYER TEMPLATES (Zpr치vy v p치rech)
        const PLAYER_TEMPLATES = [
            ["Kdy to bude hotov칳?", "U ses za캜al u캜it?"],
            ["U jsi ud캩lal tu tabulku?", "Pro캜 to v쬯ycky odkl치d치코? V 캜em je probl칠m?"],
            ["M치코 te캞 캜as? Poj캞me se to nau캜it spole캜n캩.", "U si je kontaktoval?"],
            ["Vid캩l jsem, 쬰 to je코t캩 nen칤, pro캜?", "Tebe bav칤 se nikam neposouvat?"],
            ["Tohle je fakt d콢le쬴t칠. Pot콏ebujeme to dokon캜it.", "Zkus to d캩lat jen 15 minut denn캩, to zvl치dne코!"],
            ["Co ta pr치ce?", "P콏edstav si ten tv콢j milion. Je코t캩 nesed칤코 v Lamborghini."],
            ["Chce코 b칳t milion치콏. Co ti v tom br치n칤?", "Ne콏칤kej mi, 쬰 za to m콢쬿 j치, 쬰 nic ned캩l치코!"],
            ["Chce코 rad코i d캩lat n캩co jin칠ho?", "Neud캩lal bys to sp칤코 te캞, dokud m치코 ten n치pad v hlav캩?"],
        ];

        // --- UTILITY FUNCTIONS ---

        function showMessage(text) {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.classList.remove('hidden', 'opacity-0');
            box.classList.add('opacity-100');
            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        }

        // Simulates typewriter effect
        function typewriterEffect(element, text, callback) {
            isTyping = true;
            // Disable buttons while Janis is typing
            document.querySelectorAll('.chat-option-btn').forEach(btn => btn.disabled = true);

            let i = 0;
            element.innerHTML = '<span class="typewriter-cursor"></span>'; // Start with only the cursor
            
            const typingInterval = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML = text.substring(0, i + 1) + '<span class="typewriter-cursor"></span>';
                    i++;
                } else {
                    clearInterval(typingInterval);
                    element.innerHTML = text; // Final text without the cursor
                    isTyping = false;
                    // Re-enable buttons
                    document.querySelectorAll('.chat-option-btn').forEach(btn => btn.disabled = false);
                    if (callback) callback();
                }
            }, 40); // Speed of typing
        }
        function addChatMessage(sender, text, isTypingIndicator = false) {
            const history = document.getElementById('chat-history');
            
            if (isTypingIndicator) {
                // Remove any existing typing indicator first
                const existingTyping = history.querySelector('.typing-indicator');
                if (existingTyping) {
                    existingTyping.remove();
                }
                
                const typingDiv = document.createElement('div');
                typingDiv.classList.add('typing-indicator', 'inline-flex');
                typingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
                history.appendChild(typingDiv);
            } else {
                // Remove typing indicator if it exists
                const existingTyping = history.querySelector('.typing-indicator');
                if (existingTyping) {
                    existingTyping.remove();
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', 'text-sm', 'font-normal');
                messageDiv.textContent = text;
                
                if (sender === 'player') {
                    messageDiv.classList.add('player-bubble');
                } else if (sender === 'janis') {
                    messageDiv.classList.add('janis-bubble');
                }

                history.appendChild(messageDiv);
            }
            
            history.scrollTop = history.scrollHeight; // Scroll to bottom
        }

        /**
         * Vr치t칤 bezpe캜n칳 n치hodn칳 index, kter칳 nen칤 v historii. Aktualizuje historii.
         * @param {Array} array Pole, ze kter칠ho se m치 vyb칤rat.
         * @param {Array<number>} historyArray Historie ji pou쬴t칳ch index콢.
         * @returns {number} N치hodn칳 index.
         */
        function getSafeRandomIndex(array, historyArray) {
            // Pokud je pole men코칤 nebo rovno limitu, mus칤me povolit opakov치n칤, ale pokus칤me se o cyklus.
            // V na코em p콏칤pad캩 m치me sady zpr치v > 5, tak쬰 by se opakov치n칤 nem캩lo hned st치t.
            if (array.length <= HISTORY_LIMIT) {
                return Math.floor(Math.random() * array.length);
            }

            let newIndex;
            let attemptCount = 0;
            const maxAttempts = 100; // Omez칤me po캜et pokus콢 pro jistotu

            do {
                newIndex = Math.floor(Math.random() * array.length);
                attemptCount++;
                if (attemptCount > maxAttempts) break; // Zabr치n칤me zacyklen칤, pokud by se pole zmen코ilo
            } while (historyArray.includes(newIndex));

            // Aktualizace historie
            historyArray.push(newIndex);
            if (historyArray.length > HISTORY_LIMIT) {
                historyArray.shift(); // Odstran캩n칤 nejstar코칤ho z치znamu (FIFO)
            }
            return newIndex;
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        // ... (Z콢st치v치 nezm캩n캩no)

        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(SETTINGS_KEY);
                if (storedSettings) {
                    userSettings = JSON.parse(storedSettings);
                }
            } catch (e) {
                console.error("Error loading settings:", e);
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(userSettings));
                updateStorageStatus();
            } catch (e) {
                console.error("Error saving settings:", e);
                showMessage("Chyba: Nepoda콏ilo se ulo쬴t nastaven칤 do Local Storage.");
            }
        }

        function loadLocalState() {
            try {
                const storedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedState) {
                    gameState = JSON.parse(storedState);
                    console.log("State loaded from Local Storage.");
                } else {
                    // Initialize local state if not found
                    saveLocalState();
                }
            } catch (e) {
                console.error("Error loading local state:", e);
            }
        }

        function saveLocalState() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameState));
            } catch (e) {
                console.error("Error saving local state:", e);
            }
        }

        function updateStorageStatus() {
            const statusEl = document.getElementById('storage-status');
            const toggleEl = document.getElementById('local-storage-toggle');

            toggleEl.checked = userSettings.useLocalStorage;

            if (!isFirebaseDisabled) {
                statusEl.textContent = `Data se ukl치daj칤 pomoc칤 Firebase (U쬴vatel ID: ${userId})`;
                toggleEl.disabled = true;
            } else {
                toggleEl.disabled = false;
                if (userSettings.useLocalStorage) {
                    statusEl.textContent = `Pou쮂셨치te m칤stn칤 ukl치d치n칤 (Local Storage). Interakce se ukl치daj칤.`;
                    statusEl.classList.remove('text-red-600');
                    statusEl.classList.add('text-green-600');
                } else {
                    statusEl.textContent = `Hra je v m칤stn칤m re쬴mu bez ukl치d치n칤. Zapn캩te ukl치d치n칤 pro uchov치n칤 interakc칤.`;
                    statusEl.classList.add('text-red-600');
                    statusEl.classList.remove('text-green-600');
                }
            }
        }

        // --- GAME INTERACTION LOGIC ---
        function updatePlayerOptions() {
            const container = document.getElementById('player-options-container');
            container.innerHTML = ''; // Clear previous options

            // ZM캨NA: N치hodn칳 v칳b캩r S OMEZEN칈M OPAKOV츼N칈 sady zpr치v pro hr치캜e
            const randomIndex = getSafeRandomIndex(PLAYER_TEMPLATES, playerTemplateHistory);
            const templates = PLAYER_TEMPLATES[randomIndex];

            templates.forEach(text => {
                const button = document.createElement('button');
                button.classList.add('chat-option-btn', 'player-bubble', 'chat-message', 'cursor-pointer', 'hover:bg-blue-600', 'transition-colors');
                button.textContent = text;
                button.style.marginBottom = '8px';
                button.addEventListener('click', () => {
                    if (!isTyping && isAuthReady) {
                        handleUserSelection(text);
                    }
                });
                container.appendChild(button);
            });
        }
async function handleUserSelection(userInputText) {
            
            // 1. Add player input to chat history
            addChatMessage('player', userInputText);
            
            // 2. Show typing indicator in chat history
            addChatMessage('janis', '', true); // true = show typing indicator
            
            // 3. Generate Janis's combinatorial excuse using safe random selection
            const openingIndex = getSafeRandomIndex(OPENINGS, openingHistory);
            const middleIndex = getSafeRandomIndex(EXCUSES, excuseHistory);
            const endingIndex = getSafeRandomIndex(ENDINGS, endingHistory);

            const opening = OPENINGS[openingIndex];
            const middle = EXCUSES[middleIndex];
            const ending = ENDINGS[endingIndex];
            
            const janisExcuse = `${opening}${middle}. ${ending}`;
            
            let newCount;
            
            if (isFirebaseDisabled) {
                // FALLBACK: Update local state 
                newCount = gameState.interactionsCount + 1;
                gameState.interactionsCount = newCount;

                // Save to Local Storage if enabled
                if (userSettings.useLocalStorage) {
                    saveLocalState();
                }

            } else {
                // FIREBASE: Perform the transaction to update interaction count
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_data/janis_procrastination_game`);
                
                const result = await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);

                    let currentCount = 0;
                    if (docSnap.exists()) {
                        currentCount = docSnap.data().interactionsCount || 0;
                    }
                    
                    newCount = currentCount + 1;
                    
                    transaction.set(docRef, { interactionsCount: newCount });
                    return { newCount };
                }).catch((error) => {
                    console.error("Transaction failed: ", error);
                    showMessage("Chyba p콏i z치znamu interakce. Zkus to znovu.");
                    return null;
                });
                if (!result) return; // Exit if transaction failed
                newCount = result.newCount;
            }

            // 5. Update local state and UI
            document.getElementById('interaction-count').textContent = newCount;
            
            // 6. Display new excuse with typewriter effect directly in chat history
            setTimeout(() => {
                // Remove typing indicator and add the actual message
                addChatMessage('janis', janisExcuse);
                
                // 7. Update options for the next turn
                updatePlayerOptions();
            }, 1500); // Delay to simulate typing time
}
// --- SETTINGS MODAL LOGIC ---

        function setupSettingsModal() {
            const settingsBtn = document.getElementById('settings-button');
            const closeBtn = document.getElementById('close-settings');
            const modal = document.getElementById('settings-modal');
            const toggle = document.getElementById('local-storage-toggle');
            const modalContent = modal.querySelector('.modal-content');

            // Open Modal
            settingsBtn.addEventListener('click', () => {
                updateStorageStatus();
                modal.classList.remove('hidden', 'modal-hide', 'opacity-0');
                modal.classList.add('flex', 'opacity-100', 'modal-show');
                modalContent.style.transform = 'scale(1)';
            });

            // Close Modal with animation
            function closeModal() {
                modalContent.style.transform = 'scale(0.95)';
                modal.classList.remove('opacity-100', 'modal-show');
                modal.classList.add('opacity-0', 'modal-hide');
                setTimeout(() => modal.classList.remove('flex'), 300);
            }
            
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Toggle Handler
            toggle.addEventListener('change', () => {
                userSettings.useLocalStorage = toggle.checked;
                saveSettings();
            });
        }


        // --- FIREBASE/FIRESTORE INTEGRATION ---
        
        async function loadGameState() {
            if (!userId && !isFirebaseDisabled) return;

            if (isFirebaseDisabled) {
                // LOCAL MODE INIT
                userId = 'LOCAL_MODE_USER';
                document.getElementById('user-id-display').textContent = 'M칤stn칤 Re쬴m';
                
                if (userSettings.useLocalStorage) {
                    loadLocalState();
                    document.getElementById('user-id-display').textContent += ' (Lok치ln칤 Ukl치d치n칤)';
                } else {
                    gameState = { interactionsCount: 0 };
                    document.getElementById('user-id-display').textContent += ' (BEZ ukl치d치n칤)';
                }
                
                isAuthReady = true;
                console.log("Running in Local Mode (Firebase disabled).");

            } else {
                // FIREBASE MODE INIT
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_data/janis_procrastination_game`);
                
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        gameState = docSnap.data();
                    } else {
                        await setDoc(docRef, gameState);
                    }

                    // Set up real-time listener
                    onSnapshot(docRef, (doc) => {
                        if (doc.exists() && isAuthReady) {
                            const newGlobalState = doc.data();
                            gameState.interactionsCount = newGlobalState.interactionsCount;
                            document.getElementById('interaction-count').textContent = newGlobalState.interactionsCount;
                        }
                    });
                    isAuthReady = true;
                } catch (e) {
                    console.error("Error loading game state:", e);
                    document.getElementById('loading-screen').textContent = "Chyba p콏i na캜칤t치n칤 dat z Firebase.";
                    return;
                }
            }
            // Final UI setup (Common to both modes)
            document.getElementById('interaction-count').textContent = gameState.interactionsCount;
            updatePlayerOptions(); // Setup the dynamic options

            // Show game container
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden', 'opacity-0');
            document.getElementById('game-container').classList.add('opacity-100');
}

        async function initFirebase() {
            loadSettings(); // Na캜칤st nastaven칤 hned na za캜치tku

            // Kontrola, zda chyb칤 konfigura캜n칤 data
            const isConfigMissing = Object.keys(firebaseConfig).length === 0;
            const isTokenMissing = typeof initialAuthToken === 'undefined';

            if (isConfigMissing || isTokenMissing) {
                 console.warn("Firebase config or auth token is missing. Switching to Local Mode.");
                 isFirebaseDisabled = true;
                 await loadGameState();
                 return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                isFirebaseDisabled = true;
                await loadGameState();
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    await loadGameState();
                } else {
                    try {
                         if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                         } else {
                            await signInAnonymously(auth);
                         }
                    } catch (error) {
                         console.error("Authentication failed:", error);
                         document.getElementById('loading-screen').textContent = "Chyba autentizace. P콏ep칤n치m na m칤stn칤 re쬴m.";
                         isFirebaseDisabled = true;
                         await loadGameState();
                    }
                }
            });
        }
        
        // --- INITIALIZATION ---
        window.onload = () => {
            initFirebase();
            setupSettingsModal();
        };
    </script>
</body>
</html>
