<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Janis: Mistr Prokrastinace</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Roboto+Mono:wght@400;700&display=swap');
	
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafafa; /* Instagram-like light background */
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container-shadow {
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #dbdbdb;
        }
        .typewriter-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            margin-left: 2px;
            background-color: #262626;
            animation: blink 0.7s infinite;
        }
.text-sm {font-size: 12px!important}
@keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .chat-message {
    max-width: 80%;
    padding: 8px 12px;
    border-radius: 22px;
    margin: 8px;
    font-weight: 400;
    font-size: 12px;
    line-height: 1.4;
        text-align: left;
    padding-left: 18px;
}
        /* Janis Bubble: Instagram-like message bubble */
        .janis-bubble {
            background-color: #efefef;
            color: #262626;
            align-self: flex-start;
            border: none;
            border-bottom-left-radius: 4px;
        }
        /* Player Bubble: Instagram DM style */
        .player-bubble {
            background-color: #0095f6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .chat-history {
            height: calc(100vh - 200px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 16px;
            background-color: #fafafa;
            /* Instagram-like scrollbar */
            scrollbar-width: none;
        }
        .chat-history::-webkit-scrollbar {
            display: none;
        }
        /* Instagram header style */
        .instagram-header {
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            background: white;
            border-bottom: 1px solid #dbdbdb;
        }
        /* Typing indicator */
        .typing-indicator {
            background-color: #efefef;
            padding: 12px 16px;
            border-radius: 22px;
            align-self: flex-start;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border-bottom-left-radius: 4px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #8e8e8e;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        /* CSS pro animaci modalu */
        .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal-show .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-hide .modal-content {
            transform: scale(0.95);
            opacity: 0;
        }
        /* Instagram-style message buttons */
        .chat-option-btn {
            @apply px-4 py-3 bg-blue-500 text-white font-normal rounded-lg hover:bg-blue-600 transition duration-150 border border-blue-600 text-sm text-left w-full;
        }
.chat-option-btn:disabled {
             @apply bg-gray-100 text-gray-400 cursor-not-allowed border-gray-200;
        }
        /* Instagram bottom input bar */
        .message-input-container {
            background: white;
            border-top: 1px solid #dbdbdb;
            padding: 12px 16px;
        }

</style>
</head>
<body class="bg-white">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center text-gray-800">
        <div class="w-16 h-16 border-4 border-gray-300 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <div class="text-lg font-medium">Janis se p≈ôipojuje...</div>
        <p class="mt-2 text-sm text-gray-500">Naƒç√≠t√°m konverzaci</p>
    </div>
    <!-- Main Container -->
    <div class="w-full max-w-md mx-auto h-screen bg-white flex flex-col">
        <!-- Instagram-like Header -->
        <div class="instagram-header px-4 py-3 flex items-center justify-between border-b border-gray-300">
            <div class="flex items-center space-x-3">
                <!-- Back button -->
                <button class="text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <!-- Profile picture and name -->
                <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-pink-500 rounded-full"></div>
                <div>
                    <h2 class="font-semibold text-sm">janis_procrastination</h2>
                    <p class="text-xs text-gray-500">Online p≈ôed chv√≠l√≠</p>
                </div>
            </div>
            <!-- Settings and more options -->
            <div class="flex items-center space-x-3">
                <button class="text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                    </svg>
                </button>
                <button id="settings-button" class="text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Interface -->
        <div id="game-container" class="flex-1 flex flex-col transition-opacity duration-500 opacity-0 hidden">
            
            <!-- Chat History Display -->
            <div id="chat-history" class="chat-history flex-grow">
                <div class="janis-bubble chat-message">
                    Ahoj, jsem Janisüëã
                </div>

            </div>
        <!-- Current Response Area -->
        <div class="message-input-container">
            <!-- Typing indicator will be shown in chat history instead -->

            <!-- Dynamic Options Container -->
            <div id="player-options-container" class="space-y-3 mt-4">
                <!-- Dynamic buttons will be added here by JS -->
            </div>

            <!-- Stats bar (minimal, Instagram-style) -->
            <div class="mt-4 pt-3 border-t border-gray-200">
                <div class="flex justify-between items-center text-xs text-gray-500">
                    <span>Interakce: <span id="interaction-count" class="font-medium">0</span></span>
                    <span id="user-id-display" class="text-gray-400">Naƒç√≠t√°m...</span>
                </div>
            </div>
        </div>
</div>
    </div>

    <!-- Notification/Message Box -->
    <div id="message-box" class="fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-black bg-opacity-80 text-white text-sm rounded-lg shadow-xl hidden transition-opacity duration-300 z-50">
        <!-- Messages appear here -->
    </div>
<!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center transition-opacity duration-300 opacity-0 modal-hide">
        <div class="modal-content bg-white text-gray-900 rounded-xl p-6 w-11/12 max-w-md shadow-2xl transform scale-95">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-semibold text-slate-800">Nastaven√≠ Hry</h3>
                <button id="close-settings" class="text-gray-500 hover:text-gray-800">
                    <!-- Close Icon (X) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>

            <div class="space-y-4">
                <p class="text-sm text-gray-600 font-normal">
                    Pokud nen√≠ k dispozici Firebase, hra se automaticky spust√≠ v m√≠stn√≠m re≈æimu. Zde m≈Ø≈æete nastavit, zda se maj√≠ data (poƒçet interakc√≠) ukl√°dat lok√°lnƒõ do prohl√≠≈æeƒçe.
                </p>

                <div class="flex items-center justify-between p-3 bg-slate-100 rounded-lg border border-slate-200">
                    <label for="local-storage-toggle" class="text-slate-800 font-medium select-none cursor-pointer">
                        Ukl√°dat stav lok√°lnƒõ (do prohl√≠≈æeƒçe)
                    </label>
                    <input type="checkbox" id="local-storage-toggle" class="form-checkbox h-5 w-5 text-red-600 bg-gray-200 border-gray-300 rounded focus:ring-red-500 transition duration-150 ease-in-out cursor-pointer">
                </div>
                
                <p id="storage-status" class="text-xs text-red-600 italic font-normal"></p>
            </div>
        </div>
    </div>



    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP ---
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // Pou≈æit√≠ window.__initial_auth_token pro zamezen√≠ Temporal Dead Zone
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : undefined;
        
        // Kl√≠ƒç pro Local Storage
        const LOCAL_STORAGE_KEY = `janis_pity_game_state_local_${appId}`;
        const SETTINGS_KEY = `janis_pity_game_settings_${appId}`;


        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isFirebaseDisabled = false; // Flag pro z√°lo≈æn√≠ re≈æim
        
        let gameState = {
            interactionsCount: 0, 
        };

        let userSettings = {
            useLocalStorage: false // Default vypnuto
        };

        let isTyping = false;
        
        // --- HISTORY TRACKING FOR NON-REPETITION (new feature) ---
        const HISTORY_LIMIT = 5; // Minim√°ln√≠ poƒçet tah≈Ø p≈ôed opakov√°n√≠m
        let playerTemplateHistory = []; // Historie index≈Ø pro dvojice hr√°ƒçov√Ωch zpr√°v
        let openingHistory = []; // Historie index≈Ø pro Janisovy √∫vodn√≠ fr√°ze
        let excuseHistory = []; // Historie index≈Ø pro Janisovy hlavn√≠ v√Ωmluvy
        let endingHistory = []; // Historie index≈Ø pro Janisovy z√°vƒõreƒçn√© fr√°ze
        // ---------------------------------------------------------


        // --- GAME CONTENT (Combinatorial Excuses and Player Templates) ---

        // 1. OPENINGS (A≈æ 10 r≈Øzn√Ωch obrat≈Ø)
        const OPENINGS = [
            "Promi≈à, vƒçera jsem, bƒõhal po √∫≈ôadech. ",
            "V√≠m, ≈æe jsem to sl√≠bil, udƒõl√°m to. ",
	        "Nevƒõ≈ôil bys, co se stalo. ",
	        "Stra≈°nƒõ pomalu se uƒç√≠m, nikdy mi to ne≈°lo. ",
            "Od mala jsem mƒõl probl√©my s dochvilnost√≠. ",
            "U≈æ jako d√≠tƒõ jsem byl takov√Ω. ",
            "M√°ma mƒõ do toho nutila, m√°m k tomu teƒè odpor...",
            "U≈æ mockr√°t jsem to zkou≈°el... ",
            "Marketing nedƒõl√°m, nƒõkoho na to najdem! ",
            "Sorry, nefeeluju to, nejsem to j√°. ",
            "Promi≈à, nemƒõl jsem na to s√≠lu, padla na mƒõ deprese. ",
            "Bylo to skoro hotov√©... ",
            "Hele, fakt se sna≈æ√≠m, ale zrovna dneska je to na hlavu! ",
            "Mƒõl jsem velkou vƒõc. ",
            "Teƒè to nejde, jinak bych to udƒõlal. ",
            "Rozjel jsem to! Pak jsem zjistil, ≈æe ne... ",
            "Zdr≈æela mƒõ neƒçekan√° ud√°lost. ",
            "Musel jsem za≈ô√≠dit nƒõco jin√Ωho. ",
            "Mus√≠≈° pochopit, ≈æe to nen√≠ jen tak ",
            "Narazil jsem na probl√©m. "
        ];

        // 2. MIDDLE / MASO (P≈Øvodn√≠ v√Ωmluvy)
        const EXCUSES = [
            "U≈æ jsem na to asi fakt star√Ω ",
            "Nen√≠ to moje vina. ",
            "Mus√≠m si to srovnat v hlavƒõ... ",
            "Nejd≈ô√≠v p≈ô√≠≈°t√≠ t√Ωden, d≈ô√≠v to nep≈Øjde. ",
            "Dnes m√°m napl√°novan√Ω uklidit, v tom chaosu nem≈Ø≈æu procovat. ",
            "Odpoledne, j√° dopoledne nejsem tak produktivn√≠ ",
            "Nekus√≠me nƒõco slo≈æitƒõj≈°√≠ho, vidƒõl jsem na Instagramu jak na tom vydƒõl√°vaj√≠ velkej bal√≠k ",
            "Nev√≠m, nedok√°≈æu se na to vyladit! ",
            "Pracoval jsem na tom, ale pak jsem usnul v k≈ôesle. ",
            "K√°mo≈° mƒõl narozeniny, musel jsem se tam aspo≈à na chv√≠li pod√≠vat ",
            "Jdu ven s t√Ωpkem, vlastn√≠ 5 firem, ten kontakt se bude hodit! ",
            "To trv√° moc dlouho. Napadne mƒõ urƒçitƒõ nƒõco lep≈°√≠ho ",
            "Bylo mi fakt nƒõjak ≈°patnƒõ ",
            "M√°m nep≈ôekonatelnou √∫zkost, jsem r√°d ≈æe jsem vstal z postele ",
            "Jsem z tebe nerv√≥zn√≠, mus√≠m se j√≠t nƒõkam uklidnit ",
            "Nec√≠t√≠m se dob≈ôe, kdy≈æ mƒõ po≈ô√°d kontroluje≈°! ",
            "Ty mƒõ demotivuje≈°! ",
            "Jsem na manu√°ln√≠ pr√°ci... R√°d dƒõl√°m nƒõco, co je hned vidƒõt  ",
            "To je pravda. ≈ò√≠kala to i m√°ma ",
            "Nezn√°m nikoho, kdo by mi pomohl ",
            "Koupil jsem si vitam√≠ny",
            "Mus√≠m si odpoƒçinout ",
            "P≈Øjdu se vyspat, a≈• na to m√°m energii ",
            "Teƒè p≈ôed sv√°tkama, to v≈Øbec ne ",
            "Mnƒõ p≈ôijde, ≈æe to zbyteƒçnƒõ hrot√≠≈° ",
            "Kam tak spƒõch√°≈°? ",
            "D≈ô√≠v jsem hodnƒõ zkoumal vƒõci ",
            "M√°m √∫zkost, kdy≈æ jsi negativn√≠ ",
            "U≈æ nƒõco m√°m, u≈æ jsem to sl√≠bil ", 
            "U≈æ to m√°m v pl√°nu na z√≠tra. ",
            "Nikdo mƒõ to nikdy neuƒçil. ",
            "J√° nev√≠m, co a jak se dƒõl√°... ",
            "Chci nƒõco origin√°ln√≠ho ",
            "Mƒõl jsem slab√Ω internetov√Ω p≈ôipojen√≠ ",
            "Nebudu si na to dƒõlat tabulky, nejsem blbec! ",
            "Kdy≈æ tlaƒç√≠≈°, mƒõ to demotivuje! ",
            "Fakt se sna≈æ√≠m ",
        ];

        // 3. ENDINGS (Koncov√© fr√°ze)
        const ENDINGS = [
            "Rozhodil jsi mƒõ tou ot√°zkou",
            "Hmm, divn√Ω..",
            "Tak snad p≈ô√≠≈°tƒõ",
            "Proƒç bych lhal?",
            "M√°m posledn√≠ dobou probl√©m se soust≈ôedit",
            "Dost hektick√Ω obdob√≠",
            "P≈ô√≠≈°t√≠ t√Ωden",
	        "Myslel jsem, ≈æe si dƒõl√°≈° srandu",
        ];
        
        // PLAYER TEMPLATES (Zpr√°vy v p√°rech)
        const PLAYER_TEMPLATES = [
            ["Kdy to bude hotov√Ω?", "U≈æ ses zaƒçal uƒçit?"],
            ["U≈æ jsi udƒõlal tu tabulku?", "Proƒç to v≈ædycky odkl√°d√°≈°? V ƒçem je probl√©m?"],
            ["M√°≈° teƒè ƒças? Pojƒème se to nauƒçit spoleƒçnƒõ.", "U≈æ si je kontaktoval?"],
            ["Vidƒõl jsem, ≈æe to je≈°tƒõ nen√≠, proƒç?", "Tebe bav√≠ se nikam neposouvat?"],
            ["Tohle je fakt d≈Øle≈æit√©. Pot≈ôebujeme to dokonƒçit.", "Zkus to dƒõlat jen 15 minut dennƒõ, to zvl√°dne≈°!"],
            ["Co ta pr√°ce?", "P≈ôedstav si ten tv≈Øj milion. Je≈°tƒõ nesed√≠≈° v Lamborghini."],
            ["Chce≈° b√Ωt milion√°≈ô. Co ti v tom br√°n√≠?", "Ne≈ô√≠kej mi, ≈æe za to m≈Ø≈æu j√°, ≈æe nic nedƒõl√°≈°!"],
            ["Chce≈° rad≈°i dƒõlat nƒõco jin√©ho?", "Neudƒõlal bys to sp√≠≈° teƒè, dokud m√°≈° ten n√°pad v hlavƒõ?"],
        ];

        // --- UTILITY FUNCTIONS ---

        function showMessage(text) {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.classList.remove('hidden', 'opacity-0');
            box.classList.add('opacity-100');
            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        }

        // Simulates typewriter effect
        function typewriterEffect(element, text, callback) {
            isTyping = true;
            // Disable buttons while Janis is typing
            document.querySelectorAll('.chat-option-btn').forEach(btn => btn.disabled = true);

            let i = 0;
            element.innerHTML = '<span class="typewriter-cursor"></span>'; // Start with only the cursor
            
            const typingInterval = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML = text.substring(0, i + 1) + '<span class="typewriter-cursor"></span>';
                    i++;
                } else {
                    clearInterval(typingInterval);
                    element.innerHTML = text; // Final text without the cursor
                    isTyping = false;
                    // Re-enable buttons
                    document.querySelectorAll('.chat-option-btn').forEach(btn => btn.disabled = false);
                    if (callback) callback();
                }
            }, 40); // Speed of typing
        }
        function addChatMessage(sender, text, isTypingIndicator = false) {
            const history = document.getElementById('chat-history');
            
            if (isTypingIndicator) {
                // Remove any existing typing indicator first
                const existingTyping = history.querySelector('.typing-indicator');
                if (existingTyping) {
                    existingTyping.remove();
                }
                
                const typingDiv = document.createElement('div');
                typingDiv.classList.add('typing-indicator', 'inline-flex');
                typingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
                history.appendChild(typingDiv);
            } else {
                // Remove typing indicator if it exists
                const existingTyping = history.querySelector('.typing-indicator');
                if (existingTyping) {
                    existingTyping.remove();
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', 'text-sm', 'font-normal');
                messageDiv.textContent = text;
                
                if (sender === 'player') {
                    messageDiv.classList.add('player-bubble');
                } else if (sender === 'janis') {
                    messageDiv.classList.add('janis-bubble');
                }

                history.appendChild(messageDiv);
            }
            
            history.scrollTop = history.scrollHeight; // Scroll to bottom
        }

        /**
         * Vr√°t√≠ bezpeƒçn√Ω n√°hodn√Ω index, kter√Ω nen√≠ v historii. Aktualizuje historii.
         * @param {Array} array Pole, ze kter√©ho se m√° vyb√≠rat.
         * @param {Array<number>} historyArray Historie ji≈æ pou≈æit√Ωch index≈Ø.
         * @returns {number} N√°hodn√Ω index.
         */
        function getSafeRandomIndex(array, historyArray) {
            // Pokud je pole men≈°√≠ nebo rovno limitu, mus√≠me povolit opakov√°n√≠, ale pokus√≠me se o cyklus.
            // V na≈°em p≈ô√≠padƒõ m√°me sady zpr√°v > 5, tak≈æe by se opakov√°n√≠ nemƒõlo hned st√°t.
            if (array.length <= HISTORY_LIMIT) {
                return Math.floor(Math.random() * array.length);
            }

            let newIndex;
            let attemptCount = 0;
            const maxAttempts = 100; // Omez√≠me poƒçet pokus≈Ø pro jistotu

            do {
                newIndex = Math.floor(Math.random() * array.length);
                attemptCount++;
                if (attemptCount > maxAttempts) break; // Zabr√°n√≠me zacyklen√≠, pokud by se pole zmen≈°ilo
            } while (historyArray.includes(newIndex));

            // Aktualizace historie
            historyArray.push(newIndex);
            if (historyArray.length > HISTORY_LIMIT) {
                historyArray.shift(); // Odstranƒõn√≠ nejstar≈°√≠ho z√°znamu (FIFO)
            }
            return newIndex;
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        // ... (Z≈Øst√°v√° nezmƒõnƒõno)

        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(SETTINGS_KEY);
                if (storedSettings) {
                    userSettings = JSON.parse(storedSettings);
                }
            } catch (e) {
                console.error("Error loading settings:", e);
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(userSettings));
                updateStorageStatus();
            } catch (e) {
                console.error("Error saving settings:", e);
                showMessage("Chyba: Nepoda≈ôilo se ulo≈æit nastaven√≠ do Local Storage.");
            }
        }

        function loadLocalState() {
            try {
                const storedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedState) {
                    gameState = JSON.parse(storedState);
                    console.log("State loaded from Local Storage.");
                } else {
                    // Initialize local state if not found
                    saveLocalState();
                }
            } catch (e) {
                console.error("Error loading local state:", e);
            }
        }

        function saveLocalState() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameState));
            } catch (e) {
                console.error("Error saving local state:", e);
            }
        }

        function updateStorageStatus() {
            const statusEl = document.getElementById('storage-status');
            const toggleEl = document.getElementById('local-storage-toggle');

            toggleEl.checked = userSettings.useLocalStorage;

            if (!isFirebaseDisabled) {
                statusEl.textContent = `Data se ukl√°daj√≠ pomoc√≠ Firebase (U≈æivatel ID: ${userId})`;
                toggleEl.disabled = true;
            } else {
                toggleEl.disabled = false;
                if (userSettings.useLocalStorage) {
                    statusEl.textContent = `Pou≈æ√≠v√°te m√≠stn√≠ ukl√°d√°n√≠ (Local Storage). Interakce se ukl√°daj√≠.`;
                    statusEl.classList.remove('text-red-600');
                    statusEl.classList.add('text-green-600');
                } else {
                    statusEl.textContent = `Hra je v m√≠stn√≠m re≈æimu bez ukl√°d√°n√≠. Zapnƒõte ukl√°d√°n√≠ pro uchov√°n√≠ interakc√≠.`;
                    statusEl.classList.add('text-red-600');
                    statusEl.classList.remove('text-green-600');
                }
            }
        }

        // --- GAME INTERACTION LOGIC ---
        function updatePlayerOptions() {
            const container = document.getElementById('player-options-container');
            container.innerHTML = ''; // Clear previous options

            // ZMƒöNA: N√°hodn√Ω v√Ωbƒõr S OMEZEN√çM OPAKOV√ÅN√ç sady zpr√°v pro hr√°ƒçe
            const randomIndex = getSafeRandomIndex(PLAYER_TEMPLATES, playerTemplateHistory);
            const templates = PLAYER_TEMPLATES[randomIndex];

            templates.forEach(text => {
                const button = document.createElement('button');
                button.classList.add('chat-option-btn', 'player-bubble', 'chat-message', 'cursor-pointer', 'hover:bg-blue-600', 'transition-colors');
                button.textContent = text;
                button.style.marginBottom = '8px';
                button.addEventListener('click', () => {
                    if (!isTyping && isAuthReady) {
                        handleUserSelection(text);
                    }
                });
                container.appendChild(button);
            });
        }
async function handleUserSelection(userInputText) {
            
            // 1. Add player input to chat history
            addChatMessage('player', userInputText);
            
            // 2. Show typing indicator in chat history
            addChatMessage('janis', '', true); // true = show typing indicator
            
            // 3. Generate Janis's combinatorial excuse using safe random selection
            const openingIndex = getSafeRandomIndex(OPENINGS, openingHistory);
            const middleIndex = getSafeRandomIndex(EXCUSES, excuseHistory);
            const endingIndex = getSafeRandomIndex(ENDINGS, endingHistory);

            const opening = OPENINGS[openingIndex];
            const middle = EXCUSES[middleIndex];
            const ending = ENDINGS[endingIndex];
            
            const janisExcuse = `${opening}${middle}. ${ending}`;
            
            let newCount;
            
            if (isFirebaseDisabled) {
                // FALLBACK: Update local state 
                newCount = gameState.interactionsCount + 1;
                gameState.interactionsCount = newCount;

                // Save to Local Storage if enabled
                if (userSettings.useLocalStorage) {
                    saveLocalState();
                }

            } else {
                // FIREBASE: Perform the transaction to update interaction count
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_data/janis_procrastination_game`);
                
                const result = await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);

                    let currentCount = 0;
                    if (docSnap.exists()) {
                        currentCount = docSnap.data().interactionsCount || 0;
                    }
                    
                    newCount = currentCount + 1;
                    
                    transaction.set(docRef, { interactionsCount: newCount });
                    return { newCount };
                }).catch((error) => {
                    console.error("Transaction failed: ", error);
                    showMessage("Chyba p≈ôi z√°znamu interakce. Zkus to znovu.");
                    return null;
                });
                if (!result) return; // Exit if transaction failed
                newCount = result.newCount;
            }

            // 5. Update local state and UI
            document.getElementById('interaction-count').textContent = newCount;
            
            // 6. Display new excuse with typewriter effect directly in chat history
            setTimeout(() => {
                // Remove typing indicator and add the actual message
                addChatMessage('janis', janisExcuse);
                
                // 7. Update options for the next turn
                updatePlayerOptions();
            }, 1500); // Delay to simulate typing time
}
// --- SETTINGS MODAL LOGIC ---

        function setupSettingsModal() {
            const settingsBtn = document.getElementById('settings-button');
            const closeBtn = document.getElementById('close-settings');
            const modal = document.getElementById('settings-modal');
            const toggle = document.getElementById('local-storage-toggle');
            const modalContent = modal.querySelector('.modal-content');

            // Open Modal
            settingsBtn.addEventListener('click', () => {
                updateStorageStatus();
                modal.classList.remove('hidden', 'modal-hide', 'opacity-0');
                modal.classList.add('flex', 'opacity-100', 'modal-show');
                modalContent.style.transform = 'scale(1)';
            });

            // Close Modal with animation
            function closeModal() {
                modalContent.style.transform = 'scale(0.95)';
                modal.classList.remove('opacity-100', 'modal-show');
                modal.classList.add('opacity-0', 'modal-hide');
                setTimeout(() => modal.classList.remove('flex'), 300);
            }
            
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Toggle Handler
            toggle.addEventListener('change', () => {
                userSettings.useLocalStorage = toggle.checked;
                saveSettings();
            });
        }


        // --- FIREBASE/FIRESTORE INTEGRATION ---
        
        async function loadGameState() {
            if (!userId && !isFirebaseDisabled) return;

            if (isFirebaseDisabled) {
                // LOCAL MODE INIT
                userId = 'LOCAL_MODE_USER';
                document.getElementById('user-id-display').textContent = 'M√≠stn√≠ Re≈æim';
                
                if (userSettings.useLocalStorage) {
                    loadLocalState();
                    document.getElementById('user-id-display').textContent += ' (Lok√°ln√≠ Ukl√°d√°n√≠)';
                } else {
                    gameState = { interactionsCount: 0 };
                    document.getElementById('user-id-display').textContent += ' (BEZ ukl√°d√°n√≠)';
                }
                
                isAuthReady = true;
                console.log("Running in Local Mode (Firebase disabled).");

            } else {
                // FIREBASE MODE INIT
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/game_data/janis_procrastination_game`);
                
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        gameState = docSnap.data();
                    } else {
                        await setDoc(docRef, gameState);
                    }

                    // Set up real-time listener
                    onSnapshot(docRef, (doc) => {
                        if (doc.exists() && isAuthReady) {
                            const newGlobalState = doc.data();
                            gameState.interactionsCount = newGlobalState.interactionsCount;
                            document.getElementById('interaction-count').textContent = newGlobalState.interactionsCount;
                        }
                    });
                    isAuthReady = true;
                } catch (e) {
                    console.error("Error loading game state:", e);
                    document.getElementById('loading-screen').textContent = "Chyba p≈ôi naƒç√≠t√°n√≠ dat z Firebase.";
                    return;
                }
            }
            // Final UI setup (Common to both modes)
            document.getElementById('interaction-count').textContent = gameState.interactionsCount;
            updatePlayerOptions(); // Setup the dynamic options

            // Show game container
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden', 'opacity-0');
            document.getElementById('game-container').classList.add('opacity-100');
}

        async function initFirebase() {
            loadSettings(); // Naƒç√≠st nastaven√≠ hned na zaƒç√°tku

            // Kontrola, zda chyb√≠ konfiguraƒçn√≠ data
            const isConfigMissing = Object.keys(firebaseConfig).length === 0;
            const isTokenMissing = typeof initialAuthToken === 'undefined';

            if (isConfigMissing || isTokenMissing) {
                 console.warn("Firebase config or auth token is missing. Switching to Local Mode.");
                 isFirebaseDisabled = true;
                 await loadGameState();
                 return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                isFirebaseDisabled = true;
                await loadGameState();
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    await loadGameState();
                } else {
                    try {
                         if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                         } else {
                            await signInAnonymously(auth);
                         }
                    } catch (error) {
                         console.error("Authentication failed:", error);
                         document.getElementById('loading-screen').textContent = "Chyba autentizace. P≈ôep√≠n√°m na m√≠stn√≠ re≈æim.";
                         isFirebaseDisabled = true;
                         await loadGameState();
                    }
                }
            });
        }
        
        // --- INITIALIZATION ---
        window.onload = () => {
            initFirebase();
            setupSettingsModal();
        };
    </script>
</body>
</html>
